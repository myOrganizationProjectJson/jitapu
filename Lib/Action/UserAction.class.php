<?php/** * VeryTalk @版权所有 * @author Jason 2014 *  获取 http://www.jitapu.com爬虫 */class UserAction extends Action{    public $GetJitapuInfo;    public $GetJitapuContent;    public function _initialize() {     $this->GetJitapuInfo=M("GetJitapuInfo");     $this->GetJitapuContent=M("GetJitapuContent");    }    /**     * 入口     */    public function index(){        $this->display();    }    public function login(){        $this->display();            }    public function doLogin(){        $User=M("User");        $userName=$_POST["username"];        $password=$_POST['password'];        $password=md5($password);        $info=array(            'username'=>$userName,            'password'=>$password,            'status'=>1        );        $userInfo=$User->where($info)->find();        if($userInfo){            $_SESSION['username']=$userInfo['username'];            $_SESSION['password']=$userInfo['password'];            echo "<script>alert('登陆成功！');window.location.href='index'; </script>";        }else{            echo "<script>alert('用户名或密码错误！');window.location.href='login'; </script>";        }    }        /**     * 登出     */    public function logout(){       session_destroy();       echo "<script>alert('退出成功！');window.location.href='index'; </script>";       session_destroy();    }        /**     * 注册     */    public function register(){        $this->display();    }    /**     * 提交注册     */    public function doRegister(){        $User=M("User");        $username=$_POST["username"];        $repassword=$_POST["password"];        $email=$_POST["email"];        if($this->IsUsername($username) && $this->CheckEmail($email)){            $chackUser=$User->where(array('username'=>$username))->find();            if($chackUser){                echo "<script>alert('您的用户名已被注册过！');window.location.href='register'; </script>";                exit;            }            $chackEmail=$User->where(array('email'=>$email))->find();            if($chackEmail){                echo "<script>alert('您的Email已被注册过！');window.location.href='register'; </script>";                exit;            }            $password=md5($repassword);            $info=array(                "username"=>$username,                "password"=>$password,                "updatetime"=>time(),                "usercid"=>1,                "usertype"=>1,                "status"=>1,                "email"=>$email,                "repassword"=>$repassword            );            $userInfo=$User->add($info);            if($userInfo){                $_SESSION['username']=$username;                $_SESSION['password']=$password;                echo "<script>alert('恭喜您 注册成功！');window.location.href='index'; </script>";            }else{                echo "<script>alert('注册失败 请重新尝试！');window.location.href='register'; </script>";            }        }else{            echo "<script>alert('您输入的内容不合法请重新输入！');window.location.href='register'; </script>";        }    }            /**     * 会员录入     */    public function insert(){        $this->checkUserlogin();        $this->display();    }        public function doInsert(){        $this->checkUserlogin();        $title=$_POST['title'];        $title=strip_tags(trim($title));        $name=$_POST['name'];        $name=strip_tags(trim($name));        $con=$_POST['contant'];        $con=strip_tags(trim($con));        $username=$_SESSION["username"];        if($title && $name && $con){            $result=$this->setJitapuContent($title,$con,$name,$username);            if($result){                echo "<script>alert('操作成功！');window.location.href='insert'; </script>";            }else{                echo "<script>alert('操作失败！');window.location.href='insert'; </script>";            }        }    }    /**     * 会员录入     * @param unknown $title     * @param unknown $content     * @param unknown $name     * @param unknown $username     * @param string $cid     */    private function setJitapuContent($title,$content,$name,$username,$cid='21'){        $time=time();        $data=array(            'title'=>$title,            'cid'=>$cid,            'name'=>$name,            'username'=>$username,            'status'=>0        );        $username=$_SESSION["username"];        if($username=='admin'){            $data['status']=1;        }        $data['content']=$content;        $status=$this->GetJitapuContent->where($data)->find();        if(!$status){            $data['updatetime']=$time;            $result=$this->GetJitapuContent->add($data);        }        return $result;    }    /**     * 获取自己上传过的谱子已审核通过的     */    public function mycountY(){        $this->checkUserlogin();        $username=$_SESSION["username"];        $sql="SELECT * FROM jtp_get_jitapu_content WHERE `username`='$username' AND `status`=1";        $result=M()->query($sql);        $this->assign("locations",1);        if(!$result){            $this->assign("ref","1");        }else{            $this->assign("result",$result);        }        $this->assign("serach",'1');        $this->display("Index:index");    }    /**     * 获取自己上传过的谱子     */    public function mycount(){        $this->checkUserlogin();        $username=$_SESSION["username"];        $sql="SELECT * FROM jtp_get_jitapu_content WHERE `username`='$username'";        $result=M()->query($sql);        $this->assign("locations",1);        if(!$result){            $this->assign("ref","1");        }else{            $this->assign("result",$result);        }        $this->assign("serach",'1');        $this->display();    }    /**     * 获取自己发过得谱子详情 不管审核通过了没有     */    public function getmycount(){        $this->checkUserlogin();        if($_REQUEST['id']){            $content=$this->getPlatContent($_REQUEST['id']);            $this->assign("content",$content);            $_POST['keyword']=$content['title'];        }        $this->assign('serach','1');        $this->display("Index:index");    }    private function getPlatContent($id='',$cid='1'){        //组装查询本地        $data=array(            //'cid'=>$cid,        );        $data['id']=$id;        $info=$this->GetJitapuContent->where($data)->find();        return $info;    }       /**    * 判断用户名    * @param unknown $Argv    * @return Ambigous <boolean, unknown>    */       private function IsUsername($Argv){        $RegExp='/^[a-zA-Z0-9_]{3,16}$/'; //由大小写字母跟数字组成并且长度在3-16字符直接        return preg_match($RegExp,$Argv)?$Argv:false;    }         /**     * IsMail函数:检测是否为正确的邮件格式     * 返回值:是正确的邮件格式返回邮件,不是返回false     */       private function CheckEmail($email)    {        global $dArr;        $dArr = array(            '163.com','126.com','sina.com','yahoo.com.cn','yahoo.com','sohu.com','yeah.net','139.com',            'tom.com','21cn.com','qq.com','foxmail.com','gmail.com','hotmail.com','263.net',            'vip.qq.com','vip.163.com','vip.sina.com','vip.sina.com.cn','vip.foxmail.com',        );        if(empty($email)) return FALSE;        list($e,$d) = explode('@', $email);        if(!empty($e) && !empty($d))        {            $d = strtolower($d);            if(!in_array($d,$dArr)) return FALSE;            return preg_match('/^[a-z0-9]+([\+_\-\.]?[a-z0-9]+)*/i', $e);        }        return FALSE;    }          }?>
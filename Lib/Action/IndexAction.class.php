<?php/** * VeryTalk @版权所有 * @author Jason 2014 *  获取 http://www.jitapu.com爬虫 */class IndexAction extends Action{    public $GetJitapuInfo;    public $GetJitapuContent;    public function _initialize() {     $this->GetJitapuInfo=M("GetJitapuInfo");     $this->GetJitapuContent=M("GetJitapuContent");          file_put_contents('x1.xs', '2', FILE_APPEND);         }    /**     * 入口     */    public function index(){        $keyword=$_POST['keyword'];        $location=$_POST['location'];        $keyword=trim($keyword);        if($keyword){            if($location==1){            $result=$this->getPlatContentTitle($keyword);            $this->assign("locations",1);            }            else{            $result=$this->getPlatNames($keyword);            $this->assign("locations",2);            }          if(!$result){            $this->assign("ref","1");          }else{            $this->assign("result",$result);          }          $this->assign("serach",'1');        }else{//             if($_REQUEST['id']){//                 $content=$this->getPlatContent($_REQUEST['id']);//                 $this->assign("content",$content);//                 $_POST['keyword']=$content['title'];//             }        }        $this->assign("post",$_POST);                 for($i=0;$i<2;$i++){                     if($i==0){                        flush();                        ob_flush();                        $this->display();                        flush();                        ob_flush();                     }                     flush();                     ob_flush();                 }       // $this->display();       if(empty($result) || $_POST['isref']==1){           if($location ==1){           $this->getJitapuInfo($keyword);           }       }    }        public function getcontent(){        if($_REQUEST['id']){            $content=$this->getPlatContent($_REQUEST['id']);            $this->assign("content",$content);            $_POST['keyword']=$content['title'];        }        $this->assign('serach','1');        $this->display("index");    }            /**     *      * @param string $KeyWord 搜索的关键字     * @param number $location 0歌曲 1歌手     */    public function getJitapuInfo($KeyWords='',$location=0){        if($KeyWords=='')return;       set_time_limit(0);        /**         *  获取 http://www.jitapu.com爬虫         */        header("Content-Type: text/html; charset=UTF-8");      //  $KeyWords="亲爱";        //转码        $KeyWord=mb_convert_encoding($KeyWords, "GBK", "auto");        //urlencode        $KeyWord=urlencode($KeyWord);        //获取网页内容        $URL="http://www.jitapu.com/searchResults.aspx?KeyWord=$KeyWord&location=$location";        //得到网页内容        $html=file_get_contents($URL);        //匹配搜素结束全部内容        preg_match_all("/<div id=\"searchMain\">[\s]*<ul>[\s]*(.*)[\s]*<\/ul>[\s]*<ul>/si",$html,$con);        //将内容从GBK转成UTF编码        $con=mb_convert_encoding($con[0][0], "UTF-8", "GBK");        //如果获取的内容为空的话查询本地        if(empty($con)){             //转码//             $KeyWord=urldecode($KeyWord);//             $KeyWord=mb_convert_encoding($KeyWord, "UTF-8", "GBK");            $info=$this->getPlatContent($KeyWords,$location);            return $info;        }        //获取li标签以内的内容        preg_match_all("/<li>(.*?)<\/li>/si",$con,$conts);        //$urlTitle=preg_replace("/[\s]*/", "",$conts[1][0]); 去空格        $info = array();        foreach($conts[1] as $k=>$r){            //只要txt的            if (eregi("(TXT){1}",$r)){                //去空格                //查找URL和标题内容                preg_match_all("/<a target=\"_blank\" href='(.*?)<\/a>/si",$r,$conts);                $urlTitle=$conts[1][0];                //将url和title切割成数组                $urlTitle=explode("'>",$urlTitle);                //URL                $Url=$urlTitle[0];                $info[$k]['url']=$Url;                //TITLE                $Title=$urlTitle[1];                $info[$k]['title']=$Title;                //////////////////////////歌曲所属歌手//////////////////////////////                preg_match_all("/<\/span>.*<a href='(.*?)<\/a>/si",$r,$at);                $at=explode("'>",$at[1][0]);                $nameUrl=$at[0];                $info[$k]['nameurl']=$nameUrl;                $name=$at[1];                $info[$k]['name']=$name;//                $this->setJitapuInfo($Title,$Url,$name,$nameUrl);                $this->getJitapuContent($Url,$Title,$name);            }        }        return $info;    }    /**     * 获取详情     * @param string $URL     * @param string $title     * @param string $name     */    public function getJitapuContent($URL='',$title='',$name=''){        header("Content-Type: text/html; charset=UTF-8");        $URL="http://www.jitapu.com/".$URL;        //得到网页内容        $html=file_get_contents($URL);        preg_match_all("/<div id=\"txt\">[\s]*<pre>[\s]*(.*)[\s]*<\/pre>/si",$html,$con);        $html=mb_convert_encoding($con[1][0], "UTF-8", "GBK");        $html=preg_replace("/[-]/", "=",$html);         //保存        $this->setJitapuContent($title,$URL,$html,$name);        //将内容从GBK转成UTF编码       // echo $html;    }        /**     * 储存点击查询后的信息     * @param string $title     * @param string $titleurl     * @param string $name     * @param string $nameurl     * @param string $cid     */    public function setJitapuInfo($title='',$titleurl='',$name='',$nameurl='',$cid='1'){        $time=time();        $data=array(            'title'=>$title,            'titleurl'=>$titleurl,            'name'=>$name,            'nameurl'=>$nameurl,            'cid'=>$cid,            'status'=>1        );        $status=$this->GetJitapuInfo->where($data)->find();        if($status){//等待处理...//            if($status['updatetime']<$time-216000){//两个月//                $data['updatetime']=$time;//                $status=$this->GetJitapuInfo->where($data)->save();//            }        }else{            $data['updatetime']=$time;            $this->GetJitapuInfo->add($data);        }    }    /**     * 储存获取到的谱子     * @param unknown $title     * @param unknown $titleurl     * @param unknown $content     * @param string $cid     */    public function setJitapuContent($title,$titleurl,$content,$name,$cid='1'){            $time=time();            $data=array(                'title'=>$title,                'titleurl'=>$titleurl,                'cid'=>$cid,                'name'=>$name,                'status'=>1            );            $status=$this->GetJitapuContent->where($data)->find();            if($status){//等待处理...    //            if($status['updatetime']<$time-216000){//两个月    //                $data['updatetime']=$time;    //                $status=$this->GetJitapuInfo->where($data)->save();    //            }            }else{                $data['content']=$content;                $data['updatetime']=$time;                $this->GetJitapuContent->add($data);            }    }        /**     * 组装信息查询本地 根据标题查询     * @param string $title     * @param string $type     * @param string $cid     * @return unknown     */    public function getPlatContentTitle($title='',$type='0',$cid='1'){        //组装查询本地        $data=array(            //'cid'=>$cid,            'status'=>1        );        $type==0?$data['title']=array("like","%$title%"):$data['name']=array("like","%$title%");        $info=$this->GetJitapuContent->where($data)->select();        return $info;    }        public function getPlatNames($name){        $sql="SELECT COUNT(id) as name ,`name` as title FROM jtp_get_jitapu_content WHERE `name` LIKE '%$name%' AND `status`=1 GROUP BY `name`";        $result=M()->query($sql);        return $result;    }        public function getNameInfo(){        $name=$_REQUEST['item'];        $sql="SELECT * FROM jtp_get_jitapu_content WHERE `name`='$name' AND `status`=1";        $result=M()->query($sql);        $this->assign("locations",1);        if(!$result){            $this->assign("ref","1");        }else{            $this->assign("result",$result);        }        $this->assign("serach",'1');        $this->display("index");    }        public function getPlatContent($id='',$cid='1'){        //组装查询本地        $data=array(            //'cid'=>$cid,            'status'=>1        );        $data['id']=$id;        $info=$this->GetJitapuContent->where($data)->find();        return $info;    }    /**     * CURL     * @param unknown $url     * @param string $post_data     * @return mixed     */    public function Curl_post($url,$post_data=''){        $ch = curl_init(); //初始化curl        curl_setopt($ch, CURLOPT_URL, $url);//设置链接        curl_setopt($ch, CURLOPT_POST, 1);//设置为POST方式        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);//设置是否返回信息        curl_setopt($ch, CURLOPT_POSTFIELDS, $post_data);        $response = curl_exec($ch);//接收返回信息        // echo curl_multi_getcontent($ch);        if(curl_errno($ch)){//出错则显示错误信息            print curl_error($ch);        }        curl_close($ch); //关闭curl链接        return $response;    }}?>
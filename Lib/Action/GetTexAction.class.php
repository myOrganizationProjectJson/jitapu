<?php/** * VeryTalk @版权所有 * @author Jason 2014 *  获取 http://www.jitapu.com爬虫 */class GetTexAction extends Action{    public $GetJitapuInfo;    public $GetJitapuContent;    public function _initialize() {     set_time_limit(0);     $this->GetJitapuInfo=M("GetJitapuInfo");     $this->GetJitapuContent=M("GetJitapuContent");    }    /**     * 入口     */    public function index(){      set_time_limit(0);      $this->getText();    }        public function getText(){      //  if($KeyWords=='')return;        set_time_limit(0);        /**         *  获取 http://www.jitapu.com爬虫        */        header("Content-Type: text/html; charset=UTF-8");        $http="http://www.zhaogepu.com";        for($z=2;$z<11;$z++){        $URL="$http./txt_jitas/$z/index2.html";        //得到网页内容        $i=1;        while ($html=file_get_contents($URL)){          //  $html=file_get_contents($URL);            $i++;            $URL="$http./txt_jitas/$z/"."index".$i.".html";            //匹配搜素结束全部内容            preg_match_all("/<div class=\"list\">(.*?)[\s]*<\/div>/si",$html,$con);            //preg_match_all("/<div class=\"list\">[\s]*<ul>[\s]*(.*?)[\s]*<\/ul>[\s]*<ul>[\s]*<\/div>/si",$html,$con);            //所有的          foreach($con[1] as $k=>$content){           // $content=$con[1][0];          //  echo $content;            //获取title             preg_match_all("/<li class=\"l1\">(.*?)[\s]*<\/li>/si",$content,$con);            //获取歌手            preg_match_all("/<li class=\"l3\">(.*?)[\s]*<\/li>/si",$content,$info);            preg_match_all("/target=\"_blank\">(.*?)<\/a>/si",$info[1][0],$info);            $name=$info[1][0];            $title=$con[1][0];            preg_match_all("/<a href=\"(.*?)\"[\s]*target=\"_blank\">/si",$title,$con);            $titleUrl=$con[1][0];           // print_R($titleUrl);            preg_match_all("/target=\"_blank\">(.*?)<\/a>/si",$title,$con);            $title=$con[1][0];            $urlss= $http.$titleUrl;            $this->getJitapuContent($urlss,$title,$name);            echo $title; echo "<br/>";            flush();            ob_flush();            }       }     }        return $info;    }    /**     * 获取详情     * @param string $URL     * @param string $title     * @param string $name     */    public function getJitapuContent($URL='',$title='',$name=''){        set_time_limit(0);        header("Content-Type: text/html; charset=UTF-8");        //得到网页内容        $html=file_get_contents($URL);        preg_match_all("/<div class=\"content_txt\"><pre>(.*)<\/pre>/si",$html,$con);        $html=$con[1][0];        $html=preg_replace("/[-]/", "=",$html);         $this->setJitapuContent($title,$URL,$html,$name,2);    }        /**     * 储存点击查询后的信息     * @param string $title     * @param string $titleurl     * @param string $name     * @param string $nameurl     * @param string $cid     */    public function setJitapuInfo($title='',$titleurl='',$name='',$nameurl='',$cid='1'){        set_time_limit(0);        $time=time();        $data=array(            'title'=>$title,            'titleurl'=>$titleurl,            'name'=>$name,            'nameurl'=>$nameurl,            'cid'=>$cid,            'status'=>1        );        $status=$this->GetJitapuInfo->where($data)->find();        if($status){//等待处理...//            if($status['updatetime']<$time-216000){//两个月//                $data['updatetime']=$time;//                $status=$this->GetJitapuInfo->where($data)->save();//            }        }else{            $data['updatetime']=$time;            $this->GetJitapuInfo->add($data);        }    }    /**     * 储存获取到的谱子     * @param unknown $title     * @param unknown $titleurl     * @param unknown $content     * @param string $cid     */    public function setJitapuContent($title,$titleurl,$content,$name,$cid='1'){        set_time_limit(0);            $time=time();            $data=array(                'title'=>$title,                'titleurl'=>$titleurl,                'cid'=>$cid,                'name'=>$name,                'status'=>1            );            $status=$this->GetJitapuContent->where($data)->find();            if($status){//等待处理...    //            if($status['updatetime']<$time-216000){//两个月    //                $data['updatetime']=$time;    //                $status=$this->GetJitapuInfo->where($data)->save();    //            }            }else{                $data['content']=$content;                $data['updatetime']=$time;                $this->GetJitapuContent->add($data);            }    }              /**     * CURL     * @param unknown $url     * @param string $post_data     * @return mixed     */    public function Curl_post($url,$post_data=''){        $ch = curl_init(); //初始化curl        curl_setopt($ch, CURLOPT_URL, $url);//设置链接        curl_setopt($ch, CURLOPT_POST, 1);//设置为POST方式        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);//设置是否返回信息        curl_setopt($ch, CURLOPT_POSTFIELDS, $post_data);        $response = curl_exec($ch);//接收返回信息        // echo curl_multi_getcontent($ch);        if(curl_errno($ch)){//出错则显示错误信息            print curl_error($ch);        }        curl_close($ch); //关闭curl链接        return $response;    }}?>